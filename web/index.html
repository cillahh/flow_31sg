<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="flow">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>flow</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
<script src="flutter_bootstrap.js" async></script>

<!-- [!!! 핵심 캐시 해결 스크립트 !!!] -->
<script>
  // 이 스크립트는 'localhost' (로컬 개발)에서는 실행하지 않습니다.
  if (window.location.hostname !== 'localhost') {

    // 1. 현재 이 HTML 파일의 버전 (version.json과 일치해야 함)
    var CURRENT_VERSION = "1.0.8"; // <-- 배포 시 이 숫자를 version.json과 똑같이 올리세요.

    // 2. 캐시를 무시하고 최신 버전을 확인 (더 강력한 옵션)
    var versionRequest = new Request('/version.json', {
      method: 'GET',
      cache: 'no-cache', // 명시적으로 브라우저 캐시 사용 금지
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });

    fetch(versionRequest)
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(function(data) {
        if (data && data.version) {
          console.log('Current version: ' + CURRENT_VERSION);
          console.log('Latest version from server: ' + data.version);

          // 3. 내 버전과 최신 버전이 다르면, 캐시 무시하고 강제 새로고침
          if (CURRENT_VERSION !== data.version) {
            console.warn('New version detected! Forcing hard reload...');
            window.location.reload(true); // true = bypass cache
          } else {
            console.log('App is up to date.');
          }
        }
      })
      .catch(function(err) {
        console.error('Failed to check version:', err);
      });

  } else {
    console.log('Running on localhost, skipping cache-busting script.');
  }
</script>
</body>
</html>
